<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIM Indore Timetable Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Custom Scrollbar for the code box */
        textarea::-webkit-scrollbar { width: 8px; height: 8px; }
        textarea::-webkit-scrollbar-track { background: #1e293b; }
        textarea::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .btn-check { transition: all 0.2s; }
        .btn-check:active { transform: scale(0.98); }
    </style>
</head>
<body class="text-slate-800 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="flex items-center justify-between mb-8 pb-6 border-b border-slate-200">
            <div>
                <h1 class="text-3xl font-black text-slate-900">üìÖ IIM Indore Timetable Tool</h1>
                <p class="text-slate-500">Term IX Automation Script Generator</p>
                <div class="max-w-4xl mx-auto mt-8 mb-12 text-slate-500 text-xs text-justify px-4">
    <hr class="border-slate-200 mb-4">
    <h4 class="font-bold text-slate-600 mb-2 uppercase tracking-wide">About & Disclaimer</h4>
    
    <p class="mb-2">
        <strong>Functionality:</strong> This tool generates a Google Apps Script designed to filter the Master Timetable for IPM Term IX (Batch 2023). It identifies your selected electives and section, creating a personalized view while hiding irrelevant data. It includes features for Google Calendar integration and daily automatic synchronization with the institute's source file.
    </p>

    <p>
        <strong>Disclaimer:</strong> This software is provided "as is," without warranty of any kind. While every effort has been made to ensure accuracy, the developer is not liable for any discrepancies, missed classes, or missed examinations. 
        <span class="text-red-500 font-semibold">Users are strongly advised to cross-verify crucial dates (Exams/Quizzes) with the official emails sent by the Program Office.</span> 
        The script relies on the specific formatting of the Master Sheet; if the institute alters the file structure, the automation may fail. Use at your own risk.
    </p>
</div>
            </div>
            <div class="hidden md:block text-right text-xs text-slate-400">
                <div>Safe & Secure ‚Ä¢ Client Side Only</div>
                <div>No Data Sent to Server</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-7 space-y-8">
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded flex items-center justify-center text-xs">1</span>
                        Select Your Section
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="btnA" onclick="setSection('A')" class="p-4 rounded-xl border-2 border-blue-600 bg-blue-50 text-blue-700 font-bold text-lg transition-all">
                            Section A
                        </button>
                        <button id="btnB" onclick="setSection('B')" class="p-4 rounded-xl border-2 border-slate-200 hover:border-slate-300 text-slate-600 font-bold text-lg transition-all">
                            Section B
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold flex items-center gap-2">
                            <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded flex items-center justify-center text-xs">2</span>
                            Select Courses
                        </h2>
                        <span id="countBadge" class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded">4 Selected</span>
                    </div>
                    
                    <div class="p-3 bg-amber-50 text-amber-800 text-sm rounded-lg mb-4 border border-amber-100">
                        ‚ö†Ô∏è <strong>Note:</strong> Any course NOT selected here will be automatically blocked from your timetable.
                    </div>

                    <div id="courseGrid" class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-[400px] overflow-y-auto pr-2">
                        </div>

                    <div class="mt-4 pt-4 border-t border-slate-100 flex gap-2">
                        <input type="text" id="customInput" placeholder="Missing a Code? (e.g. XYZ)" 
                            class="flex-1 px-4 py-2 border border-slate-300 rounded-lg uppercase text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <button onclick="addCustom()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-900 transition">
                            + Add
                        </button>
                    </div>
                </div>

                <button onclick="generate()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-200 transition-all lg:hidden">
                    Generate Script üëá
                </button>
            </div>

            <div class="lg:col-span-5 space-y-6">
                
                <div class="bg-slate-900 text-slate-300 p-6 rounded-2xl">
                    <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                        <span>üìù</span> Installation Guide
                    </h3>
                    <ol class="list-decimal list-inside space-y-3 text-sm font-mono">
                        <li>
                            <a href="https://sheet.new" target="_blank" class="text-green-400 hover:underline font-bold">Click here to open a new Sheet</a>
                        </li>
                        <li>Go to <strong>Extensions</strong> ‚Üí <strong>Apps Script</strong>.</li>
                        <li>Delete existing code.</li>
                        <li><strong>Paste</strong> the code below.</li>
                        <li>Click <strong>Save (disk icon)</strong>.</li>
                        <li>Refresh the Google Sheet.</li>
                        <li>Use the new <strong>"üìö My Timetable"</strong> menu.</li>
                    </ol>
                </div>

                <div class="relative">
                    <div class="absolute top-0 right-0 p-2">
                        <button onclick="copyCode()" id="copyBtn" class="bg-white/10 backdrop-blur hover:bg-white/20 text-white border border-white/20 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">
                            <span>üìã</span> Copy Code
                        </button>
                    </div>
                    <textarea id="outputBox" readonly 
                        class="w-full h-[500px] bg-slate-800 text-green-400 font-mono text-xs p-4 pt-12 rounded-2xl resize-none focus:outline-none border-2 border-slate-700"
                        placeholder="Click options on the left to generate code..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const MASTER_URL = "https://docs.google.com/spreadsheets/d/1dnzXBXlF4-OpVblhj4DJM6kJ5l-FEACjWwun7ntTGXk/edit?usp=drive_link";
        
        const courses = [
            { code: 'BGS', name: 'Business, Govt & Society' },
            { code: 'IBH', name: 'Intro Business History' },
            { code: 'WD', name: 'Web Development' },
            { code: 'PoM', name: 'Principles of Mgmt' },
            { code: 'LE', name: 'Labor Economics' },
            { code: 'DE', name: 'Development Economics' },
            { code: 'ME', name: 'Media Ethics' },
            { code: 'HVBG', name: 'Human Values (Gita)' },
            { code: 'SMC', name: 'Marginalised Communities' },
            { code: 'RT', name: 'Rasa Theory' },
            { code: 'BPP', name: 'Blending Profit w/ Purpose' },
            { code: 'APPS', name: 'Algorithmic Paradigms' },
            { code: 'BE', name: 'Behavioral Economics' },
            { code: 'QMP', name: 'Quant Methods' },
            { code: 'MLTP', name: 'Mgmt Through Theatre' },
            { code: 'DES', name: 'Discrete Event Simulation' },
            { code: 'EBS', name: 'Eco. of Business Strategy' },
            { code: 'IPRM', name: 'IP Rights Management' },
            { code: 'ETC', name: 'Emerging Tech' },
            { code: 'LCL', name: 'Lights, Camera, Lead' },
            { code: 'SSL', name: 'Story to Strategy' },
            { code: 'T&P', name: 'Technology & Politics' }
        ];

        // --- STATE ---
        let state = {
            section: 'A',
            selected: ['BGS', 'IBH', 'WD', 'PoM'],
            custom: []
        };

        // --- INIT ---
        window.onload = () => {
            renderCourses();
            generate(); // Generate default immediately
        };

        // --- FUNCTIONS ---

        function setSection(sec) {
            state.section = sec;
            
            // Visual Toggle
            const btnA = document.getElementById('btnA');
            const btnB = document.getElementById('btnB');
            
            const active = "border-blue-600 bg-blue-50 text-blue-700";
            const inactive = "border-slate-200 hover:border-slate-300 text-slate-600";
            
            btnA.className = `p-4 rounded-xl border-2 font-bold text-lg transition-all ${sec === 'A' ? active : inactive}`;
            btnB.className = `p-4 rounded-xl border-2 font-bold text-lg transition-all ${sec === 'B' ? active : inactive}`;
            
            generate();
        }

        function renderCourses() {
            const grid = document.getElementById('courseGrid');
            grid.innerHTML = '';
            
            const allList = [...courses, ...state.custom.map(c => ({ code: c, name: 'Custom Added' }))];

            allList.forEach(c => {
                const isSelected = state.selected.includes(c.code);
                const btn = document.createElement('div');
                
                // Styling
                let css = "p-3 rounded-lg border text-left cursor-pointer transition-all select-none btn-check ";
                css += isSelected 
                    ? "border-blue-500 bg-blue-50 ring-1 ring-blue-500" 
                    : "border-slate-200 hover:border-slate-400 bg-white";
                
                btn.className = css;
                btn.onclick = () => toggle(c.code);
                
                btn.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold ${isSelected ? 'text-blue-700' : 'text-slate-700'}">${c.code}</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-wide truncate w-24">${c.name}</div>
                        </div>
                        <div class="${isSelected ? 'text-blue-600' : 'text-slate-200'}">
                            ${isSelected ? '‚úÖ' : '‚¨ú'}
                        </div>
                    </div>
                `;
                grid.appendChild(btn);
            });

            // Update Badge
            document.getElementById('countBadge').innerText = `${state.selected.length} Selected`;
        }

        function toggle(code) {
            if(state.selected.includes(code)) {
                state.selected = state.selected.filter(x => x !== code);
            } else {
                state.selected.push(code);
            }
            renderCourses();
            generate();
        }

        function addCustom() {
            const val = document.getElementById('customInput').value.trim().toUpperCase();
            if(val && !state.selected.includes(val)) {
                state.custom.push(val);
                state.selected.push(val);
                document.getElementById('customInput').value = '';
                renderCourses();
                generate();
            }
        }

        function copyCode() {
            const box = document.getElementById('outputBox');
            box.select();
            document.execCommand('copy');
            
            const btn = document.getElementById('copyBtn');
            const oldText = btn.innerHTML;
            btn.innerHTML = "‚úÖ Copied!";
            btn.classList.add("bg-green-600", "border-green-600");
            
            setTimeout(() => {
                btn.innerHTML = oldText;
                btn.classList.remove("bg-green-600", "border-green-600");
            }, 2000);
        }

        function generate() {
            const otherSec = state.section === 'A' ? 'B' : 'A';
            
            // Calc logic
            const allKnown = [...courses.map(c => c.code), ...state.custom];
            const forceRemove = allKnown.filter(c => !state.selected.includes(c));

            const script = `/**
 * IIM Indore Timetable Script - Section ${state.section}
 * Generated: ${new Date().toLocaleDateString()}
 */

// 1. CONFIGURATION
const MY_SECTION = '${state.section}';
const OTHER_SECTION = '${otherSec}';
const MASTER_SHEET_URL = '${MASTER_URL}';

const MY_COURSES = [
  ${state.selected.map(c => `'${c}'`).join(', ')},
  'Business, Government', 'History', 'Web Development', 'Management', 
  'Economics', 'Ethics', 'Values', 'Communities', 'Theory', 'Profit', 
  'Algorithm', 'Simulation', 'Strategy', 'Rights', 'Technologies', 
  'Leadership', 'Politics'
];

const FORCE_REMOVE = [
  ${forceRemove.map(c => `'${c}'`).join(', ')}
];

const FILTERED_TAB_NAME = 'My Filtered Timetable';
const MASTER_TAB_NAME = 'Original Master Timetable';

// 2. MENU
function onOpen() {
  SpreadsheetApp.getUi().createMenu('üìö My Timetable')
    .addItem('üîÑ Create/Update Timetable', 'createFilteredTimetable')
    .addSeparator()
    .addItem('‚öôÔ∏è Enable Auto-Sync', 'setupAutoSync')
    .addItem('üîï Disable Auto-Sync', 'removeAutoSync')
    .addItem('üìÖ Sync to Calendar', 'syncToCalendar')
    .addToUi();
}

function setupAutoSync() {
  removeAutoSync(false);
  ScriptApp.newTrigger('createFilteredTimetable').timeBased().atHour(6).everyDays(1).create();
  SpreadsheetApp.getUi().alert('‚úÖ Auto-Sync Enabled');
}

function removeAutoSync(showMessage = true) {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => { if(t.getHandlerFunction() === 'createFilteredTimetable') ScriptApp.deleteTrigger(t); });
  if (showMessage) SpreadsheetApp.getUi().alert('üîï Auto-Sync Disabled');
}

// 3. MAIN LOGIC
function createFilteredTimetable() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let ui = null;
  try { ui = SpreadsheetApp.getUi(); } catch (e) {}

  try {
    let externalSheet;
    try { 
      externalSheet = SpreadsheetApp.openByUrl(MASTER_SHEET_URL).getSheets()[0]; 
    } catch (e) { throw new Error("Could not access Master Sheet."); }

    const oldMaster = ss.getSheetByName(MASTER_TAB_NAME);
    if (oldMaster) ss.deleteSheet(oldMaster);
    const localMaster = externalSheet.copyTo(ss).setName(MASTER_TAB_NAME).setTabColor(null);

    const oldFiltered = ss.getSheetByName(FILTERED_TAB_NAME);
    if (oldFiltered) ss.deleteSheet(oldFiltered);
    const filteredSheet = localMaster.copyTo(ss).setName(FILTERED_TAB_NAME).setTabColor('#1E40AF');

    ss.setActiveSheet(localMaster); ss.moveActiveSheet(2);
    ss.setActiveSheet(filteredSheet); ss.moveActiveSheet(1);

    const range = filteredSheet.getDataRange();
    const values = range.getValues();
    
    let headerRowIndex = 0;
    for (let r = 0; r < 10; r++) { 
      const rowStr = values[r].join(" ").toLowerCase();
      if (rowStr.includes("date") && rowStr.includes("room")) {
        headerRowIndex = r;
        break;
      }
    }
    
    for (let i = headerRowIndex + 1; i < values.length; i++) {
      for (let j = 0; j < values[0].length; j++) {
        const cellValue = values[i][j].toString().trim();
        if (j === 0 || j === 1) continue; 
        if (cellValue === '' || /break/i.test(cellValue)) continue;

        if (shouldDeleteCell(cellValue)) {
          filteredSheet.getRange(i + 1, j + 1).clearContent(); 
        } else {
          highlightCell(filteredSheet.getRange(i + 1, j + 1), cellValue); 
        }
      }
    }
    
    if (ui) ui.alert('‚úÖ Success', 'Timetable generated!', ui.ButtonSet.OK);
    
  } catch (e) {
    if (ui) ui.alert('‚ùå Error', e.toString(), ui.ButtonSet.OK);
  }
}

function shouldDeleteCell(text) {
  const isBlocked = FORCE_REMOVE.some(term => new RegExp(\`\\\\b\${term}\\\\b\`, 'i').test(text));
  if (isBlocked) return true;

  const regexWrongSection = new RegExp(\`\\\\b\${OTHER_SECTION}\\\\s+\\\\d\`, 'i'); 
  if (regexWrongSection.test(text)) return true; 

  const isMyCourse = MY_COURSES.some(course => {
    const safeCourse = course.replace(/[.*+?^$\{‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã}()|[\\]\\\\]/g, '\\\\$&');
    return new RegExp(\`\\\\b\${safeCourse}\`, 'i').test(text);
  });

  if (!isMyCourse) return true;
  return false;
}

function highlightCell(range, text) {
  range.setBorder(true, true, true, true, true, true, '#1E40AF', SpreadsheetApp.BorderStyle.SOLID_MEDIUM);
  range.setFontWeight('bold');
  if (/quiz|exam|mid term|end term/i.test(text)) {
    range.setBorder(true, true, true, true, true, true, '#DC2626', SpreadsheetApp.BorderStyle.SOLID_THICK);
    range.setBackground('#FEE2E2'); 
  }
}

function syncToCalendar() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(FILTERED_TAB_NAME);
  const ui = SpreadsheetApp.getUi();
  
  if (!sheet) { ui.alert('‚ùå Error', 'Run Update Timetable first.', ui.ButtonSet.OK); return; }
  if (ui.alert('üìÖ Calendar Sync', 'Add to Google Calendar?', ui.ButtonSet.YES_NO) !== ui.Button.YES) return;

  try {
    const calendar = CalendarApp.getDefaultCalendar();
    const data = sheet.getDataRange().getValues();
    const timeMap = {
      2: { startH: 9, startM: 0, endH: 10, endM: 15 },
      3: { startH: 10, startM: 30, endH: 11, endM: 45 },
      4: { startH: 12, startM: 0, endH: 13, endM: 15 },
      6: { startH: 14, startM: 30, endH: 15, endM: 45 },
      7: { startH: 16, startM: 0, endH: 17, endM: 15 },
      8: { startH: 17, startM: 30, endH: 18, endM: 45 },
      9: { startH: 19, startM: 0, endH: 20, endM: 15 }
    };

    let headerRowIndex = 0;
    for (let r = 0; r < 10; r++) {
      if (data[r].join(" ").toLowerCase().includes("date")) { headerRowIndex = r; break; }
    }

    let createdCount = 0;
    let currentDate = null;

    for (let i = headerRowIndex + 1; i < data.length; i++) {
      const row = data[i];
      if (row[0] instanceof Date) currentDate = new Date(row[0]);
      else if (typeof row[0] === 'string' && row[0].includes('-')) currentDate = new Date(row[0]);
      
      if (!currentDate) continue;

      for (let colIndex in timeMap) {
        const cellValue = row[colIndex];
        if (!cellValue || cellValue.toString().trim() === '') continue;
        
        const slot = timeMap[colIndex];
        const title = cellValue.toString().trim();
        const startTime = new Date(currentDate); startTime.setHours(slot.startH, slot.startM, 0);
        const endTime = new Date(currentDate); endTime.setHours(slot.endH, slot.endM, 0);

        calendar.createEvent(title, startTime, endTime, { location: row[1] || 'TBD', description: title });
        createdCount++;
      }
    }
    ui.alert('‚úÖ Success', \`Added \${createdCount} events.\`, ui.ButtonSet.OK);
  } catch (e) { ui.alert('‚ùå Error', e.toString(), ui.ButtonSet.OK); }
}`;
            document.getElementById('outputBox').value = script;
        }
    </script>
</body>
</html>
